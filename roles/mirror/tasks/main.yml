---
# Mirror Worker Role Tasks
# ========================

- name: Check if Quay container is running
  containers.podman.podman_container_info:
    name: "{{ quay_container_name }}"
  register: mirror_quay_check
  failed_when: mirror_quay_check.containers | length == 0

- name: Check if Mirror container exists
  containers.podman.podman_container_info:
    name: "{{ mirror_container_name }}"
  register: mirror_container_check

- name: Create and start Mirror worker container
  containers.podman.podman_container:
    name: "{{ mirror_container_name }}"
    image: "{{ quay_image }}"
    state: started
    recreate: false
    command: repomirror
    volumes:
      - "{{ quay_config_dir }}:/conf/stack:Z"
      - "{{ quay_storage_dir }}:/datastorage:Z"
    restart_policy: always
    requires:
      - "{{ quay_container_name }}"
      - "{{ postgresql_container_name }}"
      - "{{ redis_container_name }}"
  when: mirror_container_check.containers | length == 0

- name: Verify Mirror worker is running
  containers.podman.podman_container_info:
    name: "{{ mirror_container_name }}"
  register: mirror_status
  until: mirror_status.containers | length > 0 and mirror_status.containers[0].State.Running
  retries: "{{ mirror_health_check_retries }}"
  delay: "{{ mirror_health_check_delay }}"

- name: Generate systemd unit file for Mirror worker container
  ansible.builtin.command:
    cmd: >
      podman generate systemd --new --name --files
      --restart-policy=always
      --requires=container-{{ quay_container_name }}.service
      --requires=container-{{ postgresql_container_name }}.service
      --requires=container-{{ redis_container_name }}.service
      {{ mirror_container_name }}
    chdir: /etc/systemd/system
  register: mirror_systemd_result
  changed_when: mirror_systemd_result.rc == 0
  failed_when: false

- name: Enable and start Mirror worker systemd service
  ansible.builtin.systemd:
    name: "container-{{ mirror_container_name }}.service"
    enabled: true
    state: started
    daemon_reload: true
  when: mirror_systemd_result.rc == 0

- name: Display Mirror worker information
  ansible.builtin.debug:
    msg: |

      ============================================
      Quay Mirror Worker is running!
      ============================================

      The mirror worker shares the Quay configuration
      and will automatically sync mirrored repositories.

      To configure repository mirroring:
      1. Go to Quay web interface
      2. Navigate to Repository Settings > Repository Mirroring
      3. Enable mirroring and configure the source

      ============================================
