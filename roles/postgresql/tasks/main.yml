---
# PostgreSQL Role Tasks
# =====================

- name: Create PostgreSQL data directory
  ansible.builtin.file:
    path: "{{ postgresql_data_dir }}"
    state: directory
    mode: '0755'

- name: Set ACL for PostgreSQL data directory
  ansible.posix.acl:
    path: "{{ postgresql_data_dir }}"
    entity: "{{ postgresql_uid }}"
    etype: user
    permissions: rwx
    state: present

- name: Pull PostgreSQL container image
  containers.podman.podman_image:
    name: "{{ postgresql_image }}"
    state: present

- name: Check if PostgreSQL container exists
  containers.podman.podman_container_info:
    name: "{{ postgresql_container_name }}"
  register: postgresql_container_check

# Stop systemd services first to prevent auto-restart race condition
- name: Stop and disable dependent systemd services
  ansible.builtin.systemd:
    name: "container-{{ item }}.service"
    state: stopped
    enabled: false
  loop:
    - "{{ quay_container_name }}"
    - "{{ clair_container_name }}"
    - "{{ mirror_container_name }}"
    - "{{ postgresql_container_name }}"
    - "{{ redis_container_name }}"
  failed_when: false
  register: postgresql_dependent_services_stop

# Force remove dependent containers to ensure PostgreSQL can be updated/recreated
# This prevents "container has dependent containers" errors
- name: Remove dependent containers before PostgreSQL operations
  ansible.builtin.command:
    cmd: podman rm -f {{ item }}
  loop:
    - "{{ quay_container_name }}"
    - "{{ clair_container_name }}"
    - "{{ mirror_container_name }}"
  register: postgresql_dependent_remove
  failed_when: false
  changed_when: postgresql_dependent_remove.rc == 0

- name: Create and start PostgreSQL container
  containers.podman.podman_container:
    name: "{{ postgresql_container_name }}"
    image: "{{ postgresql_image }}"
    state: started
    recreate: false
    delete_depend: true
    ports:
      - "{{ postgresql_port }}:5432"
    env:
      POSTGRES_USER: "{{ postgresql_user }}"
      POSTGRES_PASSWORD: "{{ vault_postgresql_password }}"
      POSTGRES_DB: "{{ postgresql_database }}"
      # For Red Hat PostgreSQL image compatibility
      POSTGRESQL_USER: "{{ postgresql_user }}"
      POSTGRESQL_PASSWORD: "{{ vault_postgresql_password }}"
      POSTGRESQL_DATABASE: "{{ postgresql_database }}"
      POSTGRESQL_ADMIN_PASSWORD: "{{ vault_postgresql_admin_password }}"
    volumes:
      - "{{ postgresql_data_dir }}:{% if quay_distribution == 'redhat' %}/var/lib/pgsql/data{% else %}/var/lib/postgresql/data{% endif %}:Z"
    restart_policy: always
    healthcheck: "CMD-SHELL pg_isready -U {{ postgresql_user }} -d {{ postgresql_database }} || exit 1"
    healthcheck_interval: "10s"
    healthcheck_timeout: "5s"
    healthcheck_retries: 5
    healthcheck_start_period: "30s"

- name: Ensure PostgreSQL container is running
  containers.podman.podman_container:
    name: "{{ postgresql_container_name }}"
    state: started

- name: Wait for PostgreSQL to be ready
  ansible.builtin.command:
    cmd: >
      podman exec {{ postgresql_container_name }}
      pg_isready -U {{ postgresql_user }} -d {{ postgresql_database }}
  register: postgresql_ready
  until: postgresql_ready.rc == 0
  retries: "{{ postgresql_health_check_retries }}"
  delay: "{{ postgresql_health_check_delay }}"
  changed_when: false

- name: Enable pg_trgm extension for Quay
  ansible.builtin.command:
    cmd: >
      podman exec {{ postgresql_container_name }}
      psql -U {{ postgresql_user }} -d {{ postgresql_database }}
      -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"
  register: postgresql_trgm_result
  changed_when: "'CREATE EXTENSION' in postgresql_trgm_result.stdout"
  failed_when: postgresql_trgm_result.rc != 0 and 'already exists' not in postgresql_trgm_result.stderr

- name: Check if Clair database exists
  ansible.builtin.command:
    cmd: >
      podman exec {{ postgresql_container_name }}
      psql -U {{ postgresql_user }} -d postgres -tAc
      "SELECT 1 FROM pg_database WHERE datname='{{ clair_postgresql_database }}';"
  register: postgresql_clair_db_check
  changed_when: false
  failed_when: false
  when: quay_enable_clair | bool

- name: Create Clair database (if Clair enabled and doesn't exist)
  ansible.builtin.command:
    cmd: >
      podman exec {{ postgresql_container_name }}
      psql -U {{ postgresql_user }} -d postgres
      -c "CREATE DATABASE {{ clair_postgresql_database }};"
  register: postgresql_clair_db_result
  changed_when: postgresql_clair_db_result.rc == 0
  when:
    - quay_enable_clair | bool
    - postgresql_clair_db_check.stdout != '1'

- name: Generate systemd unit file for PostgreSQL container
  ansible.builtin.command:
    cmd: >
      podman generate systemd --new --name --files
      --restart-policy=always
      {{ postgresql_container_name }}
    chdir: /etc/systemd/system
  register: postgresql_systemd_result
  changed_when: postgresql_systemd_result.rc == 0
  failed_when: false

- name: Enable and start PostgreSQL systemd service
  ansible.builtin.systemd:
    name: "container-{{ postgresql_container_name }}.service"
    enabled: true
    state: started
    daemon_reload: true
  when: postgresql_systemd_result.rc == 0

- name: Display PostgreSQL connection info
  ansible.builtin.debug:
    msg: |
      PostgreSQL is running:
        Host: {{ quay_hostname }}
        Port: {{ postgresql_port }}
        Database: {{ postgresql_database }}
        User: {{ postgresql_user }}
